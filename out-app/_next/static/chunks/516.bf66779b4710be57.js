"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[516],{5516:function(e,r,t){t.r(r),t.d(r,{default:function(){return d}});var n=t(7437),l=t(2265),s=t(8473),c=t(6720),a=t(9733),u=t(8185),i=t(2686);let o=null;function d(e){let{onScanSuccess:r,isActive:d}=e,D=(0,l.useRef)(null),m=(0,l.useRef)("qr-scanner-".concat(Date.now(),"-").concat(Math.random())),x=(0,l.useRef)(!0),h=(0,l.useRef)(!1),g=(0,l.useRef)(!1),f=(0,l.useRef)(!1),k=(0,l.useRef)(null),b=(0,l.useRef)(null),[j,v]=(0,l.useState)(!1),[N,p]=(0,l.useState)([]),[w,y]=(0,l.useState)(""),[C,E]=(0,l.useState)(""),[S,T]=(0,l.useState)(!1),[z,R]=(0,l.useState)(""),[F,$]=(0,l.useState)(0),[A,H]=(0,l.useState)(""),M=(0,l.useCallback)(function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;e?(f.current=!0,s.k.log("\uD83D\uDD12 状态锁已锁定"),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{f.current&&(s.k.warn("⚠️ 状态锁超时，强制释放"),f.current=!1)},r)):(f.current=!1,s.k.log("\uD83D\uDD13 状态锁已释放"),b.current&&(clearTimeout(b.current),b.current=null))},[]),O=(0,l.useCallback)(async()=>{if(o){try{s.k.log("\uD83E\uDDF9 强制清理全局扫描器实例...");let e=o.getState();2===e&&await o.stop(),await o.clear()}catch(e){s.k.warn("⚠️ 清理全局扫描器时出错:",(0,c.e$)(e))}o=null}},[]),L=(0,l.useCallback)(async()=>{if(s.k.log("\uD83E\uDDF9 开始清理扫描器，当前状态锁:",f.current),f.current){s.k.log("⏸️ 正在状态转换中，跳过清理");return}M(!0,3e3);try{if(k.current&&(clearTimeout(k.current),k.current=null),h.current){s.k.log("⏸️ 已经在清理中，跳过");return}let e=D.current;if(!e){v(!1);return}if(h.current=!0,D.current=null,s.k.log("\uD83E\uDDF9 开始清理扫描器实例..."),!x.current){s.k.log("⚠️ 组件已卸载，跳过清理");return}let r=e.getState();s.k.log("\uD83D\uDCCA 扫描器状态:",r),2===r&&(await e.stop(),s.k.log("✅ 扫描器已停止"));let t=document.getElementById(m.current);if(t)try{t.innerHTML=""}catch(r){let e=(0,c.e$)(r);s.k.warn("⚠️ DOM清理出错:",e)}try{await e.clear(),s.k.log("✅ 扫描器已清理")}catch(r){let e=(0,c.e$)(r);e.includes("removeChild")||e.includes("Node")||e.includes("DOMException")||s.k.warn("⚠️ clear() 出错:",e)}}catch(e){s.k.warn("⚠️ 清理过程出错:",(0,c.e$)(e)),x.current&&H("扫描器清理失败，请点击重试")}finally{h.current=!1,M(!1),D.current=null,x.current&&v(!1),s.k.log("\uD83E\uDDF9 清理函数完成，状态锁已释放")}},[M]),_=(0,l.useCallback)(async()=>{if(s.k.log("\uD83D\uDD0D 开始启动扫描器，当前状态:",{isMounted:x.current,isActive:d,isStarting:g.current,isCleaning:h.current,isTransitioning:f.current}),!x.current||!d){s.k.log("⏸️ 组件未挂载或未激活，跳过启动");return}if(g.current||h.current||f.current){s.k.log("⏸️ 正在启动、清理或状态转换中，跳过");return}M(!0,5e3);try{try{await O()}catch(e){s.k.warn("⚠️ 强制清理失败，继续启动:",(0,c.e$)(e))}g.current=!0,s.k.log("\uD83D\uDD0D 开始启动扫描器..."),E(""),H("");let e=(await Promise.all([t.e(52),t.e(377),t.e(229)]).then(t.bind(t,2229))).Html5Qrcode;if(!x.current||!d){s.k.log("⏸️ 组件状态变化，退出启动");return}let n=document.getElementById(m.current);if(!n)throw Error("扫描器容器不存在");n.innerHTML="";let l=await e.getCameras();if(!l||0===l.length)throw Error("未找到可用的摄像头设备");let a=l.map((e,r)=>({id:e.id,label:e.label||"摄像头 ".concat(r+1)}));p(a);let u=w;if(!u){let e=l.find(e=>{var r,t;return(null===(r=e.label)||void 0===r?void 0:r.toLowerCase().includes("back"))||(null===(t=e.label)||void 0===t?void 0:t.toLowerCase().includes("environment"))});u=(null==e?void 0:e.id)||l[0].id,y(u)}s.k.log("\uD83D\uDCF9 创建扫描器实例...");let h=new e(m.current);o=h,m.current,D.current=h,s.k.log("\uD83D\uDCF9 启动摄像头, cameraId:",u),await h.start(u,{fps:i.Uf.FPS,qrbox:{width:i.Uf.QRBOX_WIDTH,height:i.Uf.QRBOX_HEIGHT}},e=>{x.current&&(s.k.log("✅ 扫描成功:",e),r(e))},e=>{let r="string"==typeof e?e:String(e);r.includes("No QR code found")||r.includes("NotFoundException")||s.k.warn("⚠️ 扫描警告:",e)}),v(!0),$(0),s.k.log("✅ 扫描器启动成功")}catch(r){s.k.error("❌ 扫描器启动失败:",r),D.current=null,o=null;let e=(0,c.e$)(r);(null==r?void 0:r.name)==="NotAllowedError"?e="摄像头权限被拒绝，请允许访问摄像头":(null==r?void 0:r.name)==="NotFoundError"?e="未找到摄像头设备":(null==r?void 0:r.name)==="NotReadableError"?e="摄像头被其他应用占用":(null==r?void 0:r.name)==="NotSupportedError"&&(e="浏览器不支持摄像头功能"),e.includes("transition")||e.includes("removeChild")||e.includes("DOMException")?(s.k.error("\uD83D\uDEA8 关键错误，设置关键错误状态:",e),H("扫描器故障: ".concat(e))):E(e),v(!1),e.includes("transition")&&F<3&&(s.k.log("\uD83D\uDD04 状态转换错误，尝试第 ".concat(F+1," 次重试...")),$(e=>e+1),setTimeout(()=>{x.current&&d&&_()},1e3))}finally{g.current=!1,M(!1),s.k.log("\uD83D\uDD0D 启动函数完成，状态锁已释放")}},[d,w,r,F,O,M]),I=(0,l.useCallback)(async e=>{if(s.k.log("\uD83D\uDD04 开始切换摄像头:",e),f.current){s.k.log("⏸️ 正在状态转换中，跳过摄像头切换");return}if(!D.current||e===w){s.k.log("⏸️ 无扫描器实例或相同摄像头，跳过切换");return}M(!0,3e3);try{s.k.log("\uD83D\uDD04 切换摄像头到:",e),y(e),H(""),await L()}catch(e){s.k.warn("⚠️ 切换摄像头时清理失败:",(0,c.e$)(e))}finally{M(!1),k.current=setTimeout(()=>{x.current&&d&&_()},600)}},[L,d,w,M,_]),B=(0,l.useCallback)(async()=>{if(s.k.log("\uD83D\uDD04 开始重启扫描器..."),f.current){s.k.log("⏸️ 正在状态转换中，跳过重启");return}M(!0,3e3);try{s.k.log("\uD83D\uDD04 重启扫描器..."),H(""),E(""),$(0),await L()}catch(e){s.k.warn("⚠️ 重启时清理失败:",(0,c.e$)(e))}finally{M(!1),k.current=setTimeout(()=>{x.current&&d&&_()},600)}},[L,d,M,_]),Q=(0,l.useCallback)(async()=>{s.k.log("\uD83D\uDD04 处理关键错误重试..."),H(""),E(""),$(0),g.current=!1,h.current=!1,M(!1),await B()},[B,M]);return((0,l.useEffect)(()=>{x.current=!0,Promise.all([t.e(52),t.e(377),t.e(229)]).then(t.bind(t,2229)).then(()=>{x.current&&T(!0)}).catch(e=>{x.current&&R((0,c.e$)(e))});let e=()=>{O()};return window.addEventListener("beforeunload",e),()=>{x.current=!1,window.removeEventListener("beforeunload",e),k.current&&clearTimeout(k.current),b.current&&clearTimeout(b.current),M(!1),L(),O()}},[L,O,M]),(0,l.useEffect)(()=>{S&&(!d||D.current||g.current?!d&&D.current&&L():_())},[d,S,_,L]),z)?(0,n.jsx)(u.Zb,{className:"shadow-xl border-0",children:(0,n.jsxs)(u.aY,{className:"text-center py-8",children:[(0,n.jsx)("div",{className:"text-3xl mb-4",children:"❌"}),(0,n.jsx)("p",{className:"text-red-600 mb-4",children:z}),(0,n.jsx)(a.z,{onClick:()=>window.location.reload(),children:"\uD83D\uDD04 刷新页面"})]})}):A?(0,n.jsxs)(u.Zb,{className:"shadow-xl border-0 border-red-200",children:[(0,n.jsx)(u.Ol,{children:(0,n.jsx)(u.ll,{className:"text-center text-red-600",children:"\uD83D\uDEA8 扫描器故障"})}),(0,n.jsxs)(u.aY,{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"text-4xl mb-4",children:"\uD83D\uDCA5"}),(0,n.jsx)("p",{className:"text-red-800 font-medium mb-2",children:A}),(0,n.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"扫描器遇到了严重错误，但可以安全重试"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(a.z,{onClick:Q,className:"w-full bg-red-600 hover:bg-red-700",children:"\uD83D\uDD04 安全重试扫描器"}),(0,n.jsx)(a.z,{onClick:()=>window.location.reload(),variant:"outline",className:"w-full",children:"\uD83D\uDD03 刷新整个页面"})]}),(0,n.jsxs)("div",{className:"text-xs text-gray-500 bg-red-50 p-3 rounded-lg",children:[(0,n.jsx)("p",{children:"\uD83D\uDCA1 提示：如果持续出现此错误，可能是："}),(0,n.jsxs)("ul",{className:"mt-1 ml-4 list-disc space-y-1",children:[(0,n.jsx)("li",{children:"摄像头被其他应用占用"}),(0,n.jsx)("li",{children:"浏览器权限设置问题"}),(0,n.jsx)("li",{children:"设备兼容性问题"})]})]})]})]}):S?(0,n.jsxs)(u.Zb,{className:"shadow-xl border-0",children:[(0,n.jsx)(u.Ol,{children:(0,n.jsx)(u.ll,{className:"text-center",children:"扫码核验"})}),(0,n.jsxs)(u.aY,{className:"space-y-4",children:[N.length>1&&(0,n.jsxs)("div",{className:"w-full",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"选择摄像头"}),(0,n.jsx)("select",{value:w,onChange:e=>I(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:N.map(e=>(0,n.jsx)("option",{value:e.id,children:e.label},e.id))})]}),(0,n.jsxs)("div",{className:"relative w-full",style:{minHeight:"300px"},children:[(0,n.jsx)("div",{id:m.current,className:"w-full",style:{backgroundColor:"#000"}}),C&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50 rounded-lg border border-red-200",children:(0,n.jsxs)("div",{className:"text-center p-4",children:[(0,n.jsx)("div",{className:"text-3xl mb-2",children:"❌"}),(0,n.jsx)("p",{className:"text-sm text-red-800 mb-4",children:C}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("div",{className:"flex space-x-2",children:[(0,n.jsx)(a.z,{onClick:B,variant:"outline",size:"sm",children:"\uD83D\uDD04 重试"}),(0,n.jsx)(a.z,{onClick:()=>{E(""),$(0),_()},variant:"outline",size:"sm",children:"\uD83D\uDD27 强制重启"})]}),F>=2&&(0,n.jsx)(a.z,{onClick:Q,variant:"destructive",size:"sm",className:"w-full",children:"\uD83D\uDEA8 深度重置"})]})]})}),!j&&!C&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 rounded-lg border-2 border-dashed border-gray-300",children:(0,n.jsxs)("div",{className:"text-center p-4",children:[(0,n.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDCF7"}),(0,n.jsx)("p",{className:"text-sm text-gray-600",children:"正在启动摄像头..."})]})})]}),(0,n.jsxs)("div",{className:"flex space-x-2",children:[(0,n.jsx)(a.z,{onClick:B,variant:"outline",size:"sm",className:"flex-1",children:"\uD83D\uDD27 重启扫描器"}),(0,n.jsx)(a.z,{onClick:()=>{O(),setTimeout(()=>{x.current&&_()},100)},variant:"outline",size:"sm",className:"flex-1",children:"\uD83D\uDCF9 强制刷新"})]}),(0,n.jsxs)("div",{className:"text-xs text-gray-500 space-y-1",children:[(0,n.jsxs)("p",{children:["• 库加载状态: ",S?"✅":"❌"]}),(0,n.jsxs)("p",{children:["• 扫描器状态: ",j?"✅ 正在扫描":"❌ 未扫描"]}),(0,n.jsxs)("p",{children:["• 可用摄像头: ",N.length," 个"]}),(0,n.jsxs)("p",{children:["• 重试次数: ",F]}),(0,n.jsxs)("p",{children:["• 状态锁: ",f.current?"\uD83D\uDD12 锁定":"\uD83D\uDD13 就绪"]}),A&&(0,n.jsxs)("p",{className:"text-red-600",children:["• \uD83D\uDEA8 关键错误: ",A]}),w&&(0,n.jsxs)("p",{children:["• 当前摄像头: ",w]})]})]})]}):(0,n.jsx)(u.Zb,{className:"shadow-xl border-0",children:(0,n.jsxs)(u.aY,{className:"text-center py-8",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,n.jsx)("p",{className:"text-gray-600",children:"正在加载扫码功能..."})]})})}},6720:function(e,r,t){function n(e){return e&&"object"==typeof e?{name:"name"in e?String(e.name):void 0,message:"message"in e?String(e.message):void 0,code:"code"in e&&("string"==typeof e.code||"number"==typeof e.code)?e.code:void 0,stack:"stack"in e?String(e.stack):void 0}:"string"==typeof e?{message:e}:{message:String(e)}}function l(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"未知错误";return n(e).message||r}function s(e,r){return n(e).code===r}t.d(r,{bh:function(){return s},e$:function(){return l}})}}]);